<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Debian Installation Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff00;
            overflow: hidden;
            height: 100vh;
        }

        .terminal {
            width: 100%;
            height: 100vh;
            background: #000;
            padding: 20px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.4;
        }

        .installer-screen {
            display: none;
            background: #000080;
            color: #fff;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
        }

        .installer-screen.active {
            display: block;
        }

        .installer-header {
            background: #0000ff;
            color: #fff;
            padding: 10px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid #fff;
        }

        .installer-content {
            background: #000080;
            padding: 20px;
            border: 1px solid #fff;
            margin-bottom: 20px;
        }

        .menu-item {
            padding: 5px 10px;
            margin: 2px 0;
            cursor: pointer;
            background: #000080;
            border: 1px solid transparent;
        }

        .menu-item:hover, .menu-item.selected {
            background: #ff0000;
            border: 1px solid #fff;
        }

        .input-field {
            background: #000080;
            color: #fff;
            border: 1px solid #fff;
            padding: 5px;
            margin: 5px 0;
            font-family: 'Courier New', monospace;
        }

        .button {
            background: #000080;
            color: #fff;
            border: 2px solid #fff;
            padding: 8px 16px;
            margin: 10px 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }

        .button:hover {
            background: #ff0000;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #000080;
            border: 1px solid #fff;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #00ff00;
            width: 0%;
            transition: width 0.5s;
        }

        .login-screen {
            display: none;
            background: #000 !important;
            color: #fff !important;
            padding: 20px;
            height: 100vh !important;
            font-family: 'Courier New', monospace;
            overflow-y: auto;
            word-wrap: break-word;
            white-space: pre-wrap;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            z-index: 1000 !important;
        }

        /* Mobile Support Styles */
        .mobile-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
            font-size: 16px; /* Prevent zoom on iOS */
        }

        .mobile-keyboard-trigger {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: #fff;
            border: 2px solid #555;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            z-index: 1001;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .mobile-keyboard-trigger:hover {
            background: #555;
            transform: translateY(-2px);
        }

        .mobile-keyboard-trigger.active {
            background: #007700;
            border-color: #00aa00;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 4px 15px rgba(0,119,0,0.5); }
            100% { box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        }

        .mobile-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 1002;
            display: none;
        }

        @media (max-width: 768px) {
            .terminal, .login-screen {
                font-size: 12px;
                padding: 10px;
            }
            
            .installer-screen {
                font-size: 12px;
                padding: 10px;
            }
            
            .mobile-keyboard-trigger {
                display: block;
            }
            
            .nano-editor {
                font-size: 12px;
            }
            
            .nano-content {
                padding: 5px;
            }
            
            .nano-textarea {
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .terminal, .login-screen {
                font-size: 11px;
                padding: 5px;
            }
            
            .installer-screen {
                font-size: 11px;
                padding: 5px;
            }
            
            .mobile-keyboard-trigger {
                bottom: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        #loginContent {
            max-width: 100%;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .login-screen.active {
            display: block;
        }

        .cursor {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .typing {
            border-right: 2px solid #00ff00;
            animation: blink 1s infinite;
        }

        .nano-editor {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            z-index: 1000;
        }

        .nano-editor.active {
            display: flex;
            flex-direction: column;
        }

        .nano-header {
            background: #000;
            color: #fff;
            padding: 5px;
            border-bottom: 1px solid #333;
            font-size: 12px;
        }

        .nano-content {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            white-space: pre;
            font-size: 14px;
            line-height: 1.2;
            background: #000;
            color: #fff;
        }

        .nano-textarea {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.2;
            resize: none;
            white-space: pre;
        }

        .nano-footer {
            background: #000;
            color: #fff;
            padding: 5px;
            border-top: 1px solid #333;
            font-size: 12px;
        }

        .nano-status {
            background: #000080;
            color: #fff;
            padding: 2px 5px;
            margin: 2px 0;
        }
    </style>
</head>
<body>
    <!-- Boot Screen -->
    <div id="bootScreen" class="terminal"></div>

    <!-- Language Selection -->
    <div id="languageScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Debian GNU/Linux installer boot menu</h2>
        </div>
        <div class="installer-content">
            <h3>Select a language</h3>
            <div class="menu-item selected" onclick="selectLanguage('English')">English</div>
            <div class="menu-item" onclick="selectLanguage('Bahasa Indonesia')">Bahasa Indonesia</div>
            <div class="menu-item" onclick="selectLanguage('FranÃ§ais')">FranÃ§ais</div>
            <div class="menu-item" onclick="selectLanguage('Deutsch')">Deutsch</div>
        </div>
        <button class="button" onclick="nextStep('hardwareScreen')">Continue</button>
    </div>

    <!-- Detect Hardware -->
    <div id="hardwareScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Detecting hardware and loading components</h2>
        </div>
        <div class="installer-content">
            <h3>Please wait while the installer detects your hardware...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="hardwareProgress"></div>
            </div>
            <div id="hardwareStatus">Detecting hardware...</div>
        </div>
    </div>

    <!-- Country Selection -->
    <div id="countryScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Select your location</h2>
        </div>
        <div class="installer-content">
            <h3>Country, territory or area:</h3>
            <div class="menu-item selected" onclick="selectCountry('Indonesia')">Indonesia</div>
            <div class="menu-item" onclick="selectCountry('United States')">United States</div>
            <div class="menu-item" onclick="selectCountry('United Kingdom')">United Kingdom</div>
            <div class="menu-item" onclick="selectCountry('Germany')">Germany</div>
        </div>
        <button class="button" onclick="nextStep('keyboardScreen')">Continue</button>
    </div>

    <!-- Keyboard Configuration -->
    <div id="keyboardScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Configure the keyboard</h2>
        </div>
        <div class="installer-content">
            <h3>Keyboard layout:</h3>
            <div class="menu-item selected" onclick="selectKeyboard('American English')">American English</div>
            <div class="menu-item" onclick="selectKeyboard('Indonesian')">Indonesian</div>
            <div class="menu-item" onclick="selectKeyboard('German')">German</div>
        </div>
        <button class="button" onclick="nextStep('timezoneScreen')">Continue</button>
    </div>

    <!-- Timezone Configuration -->
    <div id="timezoneScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Configure the clock</h2>
        </div>
        <div class="installer-content">
            <h3>Select your time zone:</h3>
            <div class="menu-item selected" onclick="selectTimezone('Asia/Jakarta')">Asia/Jakarta</div>
            <div class="menu-item" onclick="selectTimezone('America/New_York')">America/New_York</div>
            <div class="menu-item" onclick="selectTimezone('Europe/London')">Europe/London</div>
            <div class="menu-item" onclick="selectTimezone('Europe/Berlin')">Europe/Berlin</div>
            <div class="menu-item" onclick="selectTimezone('UTC')">UTC</div>
        </div>
        <button class="button" onclick="nextStep('networkScreen')">Continue</button>
    </div>

    <!-- Network Configuration -->
    <div id="networkScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Configure the network</h2>
        </div>
        <div class="installer-content">
            <h3>Hostname:</h3>
            <input type="text" class="input-field" id="hostname" value="debian" placeholder="Enter hostname">
            <h3>Domain name:</h3>
            <input type="text" class="input-field" id="domain" placeholder="Enter domain name (optional)">
        </div>
        <button class="button" onclick="nextStep('userScreen')">Continue</button>
    </div>

    <!-- User Setup -->
    <div id="userScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Set up users and passwords</h2>
        </div>
        <div class="installer-content">
            <h3>Root password:</h3>
            <input type="password" class="input-field" id="rootPassword" placeholder="Enter root password">
            <h3>Re-enter password to verify:</h3>
            <input type="password" class="input-field" id="rootPasswordConfirm" placeholder="Re-enter root password">
            <h3>Full name for the new user:</h3>
            <input type="text" class="input-field" id="fullName" placeholder="Enter full name">
            <h3>Username for your account:</h3>
            <input type="text" class="input-field" id="username" placeholder="Enter username">
            <h3>Choose a password for the new user:</h3>
            <input type="password" class="input-field" id="userPassword" placeholder="Enter user password">
        </div>
        <button class="button" onclick="nextStep('diskDetectScreen')">Continue</button>
    </div>

    <!-- Detect Disks -->
    <div id="diskDetectScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Detect disks</h2>
        </div>
        <div class="installer-content">
            <h3>Detecting disks and all other hardware...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="diskProgress"></div>
            </div>
            <div id="diskStatus">Scanning for disks...</div>
        </div>
    </div>

    <!-- Partition Disks -->
    <div id="partitionScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Partition disks</h2>
        </div>
        <div class="installer-content">
            <h3>Partitioning method:</h3>
            <div class="menu-item selected" onclick="selectPartition('guided')">Guided - use entire disk</div>
            <div class="menu-item" onclick="selectPartition('guided-lvm')">Guided - use entire disk and set up LVM</div>
            <div class="menu-item" onclick="selectPartition('guided-encrypted')">Guided - use entire disk and set up encrypted LVM</div>
            <div class="menu-item" onclick="selectPartition('manual')">Manual</div>
        </div>
        <button class="button" onclick="nextStep('diskSelectScreen')">Continue</button>
    </div>

    <!-- Select Disk -->
    <div id="diskSelectScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Select disk to partition</h2>
        </div>
        <div class="installer-content">
            <h3>Select the disk to partition:</h3>
            <div class="menu-item selected">/dev/sda - 20.0 GB Virtual Disk (VBOX HARDDISK)</div>
            <div class="menu-item">/dev/sdb - 8.0 GB USB Drive (SanDisk Ultra)</div>
        </div>
        <button class="button" onclick="nextStep('partitionSchemeScreen')">Continue</button>
    </div>

    <!-- Partition Scheme -->
    <div id="partitionSchemeScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Partition scheme</h2>
        </div>
        <div class="installer-content">
            <h3>Select partitioning scheme:</h3>
            <div class="menu-item selected" onclick="selectScheme('all-in-one')">All files in one partition (recommended for new users)</div>
            <div class="menu-item" onclick="selectScheme('separate-home')">Separate /home partition</div>
            <div class="menu-item" onclick="selectScheme('separate-home-var-tmp')">Separate /home, /var, and /tmp partitions</div>
        </div>
        <button class="button" onclick="nextStep('partitionConfirmScreen')">Continue</button>
    </div>

    <!-- Confirm Partitioning -->
    <div id="partitionConfirmScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Write changes to disks?</h2>
        </div>
        <div class="installer-content">
            <h3>Overview of your currently configured partitions and mount points:</h3>
            <div style="background: #000; color: #fff; padding: 10px; margin: 10px 0; font-family: monospace;">
/dev/sda1    ext4    /boot     512 MB<br>
/dev/sda2    ext4    /         19.5 GB<br>
/dev/sda3    swap    swap      1.0 GB
            </div>
            <p><strong>WARNING:</strong> This will destroy all data on the selected disk!</p>
            <div class="menu-item selected" onclick="confirmPartition('yes')">Yes, write changes to disk</div>
            <div class="menu-item" onclick="confirmPartition('no')">No, go back</div>
        </div>
        <button class="button" onclick="nextStep('installScreen')">Continue</button>
    </div>

    <!-- Installation Progress -->
    <div id="installScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Installing the base system</h2>
        </div>
        <div class="installer-content">
            <h3>Installing packages...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="installProgress"></div>
            </div>
            <div id="installStatus">Preparing installation...</div>
        </div>
    </div>

    <!-- Configure APT -->
    <div id="aptScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Configuring APT</h2>
        </div>
        <div class="installer-content">
            <h3>Configuring the package manager...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="aptProgress"></div>
            </div>
            <div id="aptStatus">Setting up package sources...</div>
        </div>
    </div>

    <!-- Package Manager -->
    <div id="packageScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Configure the package manager</h2>
        </div>
        <div class="installer-content">
            <h3>Use a network mirror?</h3>
            <div class="menu-item selected" onclick="selectMirror('yes')">Yes</div>
            <div class="menu-item" onclick="selectMirror('no')">No</div>
            <h3>Debian archive mirror country:</h3>
            <div class="menu-item selected">Indonesia</div>
            <div class="menu-item">United States</div>
            <div class="menu-item">Germany</div>
            <h3>Debian archive mirror:</h3>
            <div class="menu-item selected">deb.debian.org</div>
            <div class="menu-item">mirror.unej.ac.id</div>
            <div class="menu-item">kartolo.sby.datautama.net.id</div>
        </div>
        <button class="button" onclick="nextStep('proxyScreen')">Continue</button>
    </div>

    <!-- HTTP Proxy -->
    <div id="proxyScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Configure the package manager</h2>
        </div>
        <div class="installer-content">
            <h3>HTTP proxy information (blank for none):</h3>
            <input type="text" class="input-field" id="httpProxy" placeholder="http://proxy.example.com:8080/">
            <p>If you need to use a HTTP proxy to access the outside world, enter the proxy information here.</p>
        </div>
        <button class="button" onclick="nextStep('popularityScreen')">Continue</button>
    </div>

    <!-- Popularity Contest -->
    <div id="popularityScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Configuring popularity-contest</h2>
        </div>
        <div class="installer-content">
            <h3>Participate in the package usage survey?</h3>
            <p>The system may anonymously supply the distribution developers with statistics about the most used packages on this system.</p>
            <div class="menu-item selected" onclick="selectPopularity('yes')">Yes</div>
            <div class="menu-item" onclick="selectPopularity('no')">No</div>
        </div>
        <button class="button" onclick="nextStep('softwareScreen')">Continue</button>
    </div>

    <!-- Software Selection -->
    <div id="softwareScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Software selection</h2>
        </div>
        <div class="installer-content">
            <h3>Choose software to install:</h3>
            <div class="menu-item" onclick="toggleSoftware(this)">[ ] Debian desktop environment</div>
            <div class="menu-item" onclick="toggleSoftware(this)">[ ] GNOME</div>
            <div class="menu-item selected" onclick="toggleSoftware(this)">[*] SSH server</div>
            <div class="menu-item selected" onclick="toggleSoftware(this)">[*] standard system utilities</div>
        </div>
        <button class="button" onclick="nextStep('grubScreen')">Continue</button>
    </div>

    <!-- GRUB Installation -->
    <div id="grubScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Install the GRUB boot loader</h2>
        </div>
        <div class="installer-content">
            <h3>Install the GRUB boot loader to your primary drive?</h3>
            <div class="menu-item selected" onclick="selectGrub('yes')">Yes</div>
            <div class="menu-item" onclick="selectGrub('no')">No</div>
            <h3>Device for boot loader installation:</h3>
            <div class="menu-item selected">/dev/sda</div>
        </div>
        <button class="button" onclick="nextStep('finishScreen')">Continue</button>
    </div>

    <!-- Installation Complete -->
    <div id="finishScreen" class="installer-screen">
        <div class="installer-header">
            <h2>Finish the installation</h2>
        </div>
        <div class="installer-content">
            <h3>Installation complete</h3>
            <p>The system is going to reboot.</p>
            <p>Please remove the installation medium and press Continue to reboot.</p>
        </div>
        <button class="button" onclick="rebootSystem()">Continue</button>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div id="loginContent"></div>
        <!-- Hidden input for mobile keyboard -->
        <input type="text" id="mobileInput" class="mobile-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    </div>

    <!-- Mobile Keyboard Trigger Button -->
    <button id="mobileKeyboard" class="mobile-keyboard-trigger">ðŸ“± Keyboard</button>
    
    <!-- Mobile Status Indicator -->
    <div id="mobileStatus" class="mobile-status">Mobile Mode</div>

    <!-- Nano Editor -->
    <div id="nanoEditor" class="nano-editor">
        <div class="nano-header">
            <div>GNU nano 5.4</div>
            <div id="nanoFilename">New Buffer</div>
        </div>
        <div class="nano-content">
            <textarea id="nanoTextarea" class="nano-textarea" placeholder=""></textarea>
        </div>
        <div class="nano-footer">
            <div>^G Help    ^O Write Out ^W Where Is  ^K Cut       ^T Execute   ^C Location</div>
            <div>^X Exit    ^R Read File ^\ Replace   ^U Paste     ^J Justify   ^/ Go To Line</div>
        </div>
        <div id="nanoStatus" class="nano-status" style="display: none;"></div>
    </div>

    <script>
        let currentStep = 'boot';
        let installationData = {
            language: 'English',
            country: 'Indonesia',
            keyboard: 'American English',
            hostname: 'debian',
            domain: '',
            rootPassword: '',
            fullName: '',
            username: '',
            userPassword: ''
        };

        // Boot sequence
        function startBoot() {
            const bootScreen = document.getElementById('bootScreen');
            const bootMessages = [
                'BIOS Version 2.15.1236',
                'Memory Test: 2048MB OK',
                'Detecting Primary Master... IDE Hard Disk',
                'Detecting Primary Slave... None',
                'Detecting Secondary Master... ATAPI CD-ROM',
                'Detecting Secondary Slave... None',
                '',
                'Booting from CD-ROM...',
                '',
                'Loading Debian GNU/Linux installer...',
                'Loading initial ramdisk...',
                '',
                'Starting kernel...',
                '',
                '[    0.000000] Linux version 5.10.0-21-amd64',
                '[    0.000000] Command line: BOOT_IMAGE=/install.amd/vmlinuz',
                '[    0.123456] Memory: 2048MB available',
                '[    0.234567] CPU: Intel(R) Core(TM) i5-8250U CPU @ 1.60GHz',
                '[    0.345678] PCI: Found 12 devices',
                '[    0.456789] USB: 3 ports detected',
                '[    0.567890] Network: eth0 detected',
                '[    1.234567] Starting Debian installer...',
                '',
                'Welcome to Debian GNU/Linux installer!',
                '',
                'Loading installer components...'
            ];

            let i = 0;
            function typeMessage() {
                if (i < bootMessages.length) {
                    bootScreen.innerHTML += bootMessages[i] + '\n';
                    bootScreen.scrollTop = bootScreen.scrollHeight;
                    i++;
                    setTimeout(typeMessage, Math.random() * 500 + 200);
                } else {
                    setTimeout(() => {
                        bootScreen.style.display = 'none';
                        document.getElementById('languageScreen').classList.add('active');
                    }, 1000);
                }
            }
            typeMessage();
        }

        function selectLanguage(lang) {
            installationData.language = lang;
            document.querySelectorAll('#languageScreen .menu-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function selectCountry(country) {
            installationData.country = country;
            document.querySelectorAll('#countryScreen .menu-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function selectKeyboard(keyboard) {
            installationData.keyboard = keyboard;
            document.querySelectorAll('#keyboardScreen .menu-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function selectTimezone(timezone) {
            installationData.timezone = timezone;
            document.querySelectorAll('#timezoneScreen .menu-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function selectScheme(scheme) {
            document.querySelectorAll('#partitionSchemeScreen .menu-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function confirmPartition(choice) {
            document.querySelectorAll('#partitionConfirmScreen .menu-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function selectMirror(choice) {
            document.querySelectorAll('#packageScreen .menu-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function selectPopularity(choice) {
            document.querySelectorAll('#popularityScreen .menu-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function selectPartition(method) {
            document.querySelectorAll('#partitionScreen .menu-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function selectGrub(option) {
            document.querySelectorAll('#grubScreen .menu-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function toggleSoftware(element) {
            if (element.textContent.includes('[*]')) {
                element.textContent = element.textContent.replace('[*]', '[ ]');
                element.classList.remove('selected');
            } else {
                element.textContent = element.textContent.replace('[ ]', '[*]');
                element.classList.add('selected');
            }
        }

        function nextStep(stepId) {
            // Save user data
            if (currentStep === 'networkScreen') {
                installationData.hostname = document.getElementById('hostname').value || 'debian';
                installationData.domain = document.getElementById('domain').value;
            } else if (currentStep === 'userScreen') {
                const rootPass = document.getElementById('rootPassword').value;
                const rootPassConfirm = document.getElementById('rootPasswordConfirm').value;
                
                if (!rootPass) {
                    alert('Root password is required!');
                    return;
                }
                if (rootPass !== rootPassConfirm) {
                    alert('Root passwords do not match!');
                    return;
                }
                
                installationData.rootPassword = rootPass;
                installationData.fullName = document.getElementById('fullName').value;
                installationData.username = document.getElementById('username').value;
                installationData.userPassword = document.getElementById('userPassword').value;
            }

            // Hide current screen
            document.querySelectorAll('.installer-screen').forEach(screen => {
                screen.classList.remove('active');
            });

            // Show next screen with special handling for progress screens
            if (stepId === 'hardwareScreen') {
                startHardwareDetection();
            } else if (stepId === 'diskDetectScreen') {
                startDiskDetection();
            } else if (stepId === 'aptScreen') {
                startAptConfiguration();
            } else if (stepId === 'installScreen') {
                startInstallation();
            } else {
                document.getElementById(stepId).classList.add('active');
            }
            currentStep = stepId;
        }

        function startHardwareDetection() {
            document.getElementById('hardwareScreen').classList.add('active');
            const progressBar = document.getElementById('hardwareProgress');
            const statusDiv = document.getElementById('hardwareStatus');
            
            const hardwareSteps = [
                'Detecting hardware...',
                'Loading network drivers...',
                'Loading storage drivers...',
                'Loading input device drivers...',
                'Configuring hardware...'
            ];

            let step = 0;
            function updateHardwareProgress() {
                if (step < hardwareSteps.length) {
                    statusDiv.textContent = hardwareSteps[step];
                    progressBar.style.width = ((step + 1) / hardwareSteps.length * 100) + '%';
                    step++;
                    setTimeout(updateHardwareProgress, Math.random() * 1500 + 800);
                } else {
                    setTimeout(() => nextStep('countryScreen'), 1000);
                }
            }
            updateHardwareProgress();
        }

        function startDiskDetection() {
            document.getElementById('diskDetectScreen').classList.add('active');
            const progressBar = document.getElementById('diskProgress');
            const statusDiv = document.getElementById('diskStatus');
            
            const diskSteps = [
                'Scanning for disks...',
                'Loading SCSI drivers...',
                'Loading SATA drivers...',
                'Detecting partitions...',
                'Configuring disk access...'
            ];

            let step = 0;
            function updateDiskProgress() {
                if (step < diskSteps.length) {
                    statusDiv.textContent = diskSteps[step];
                    progressBar.style.width = ((step + 1) / diskSteps.length * 100) + '%';
                    step++;
                    setTimeout(updateDiskProgress, Math.random() * 1200 + 600);
                } else {
                    setTimeout(() => nextStep('partitionScreen'), 1000);
                }
            }
            updateDiskProgress();
        }

        function startAptConfiguration() {
            document.getElementById('aptScreen').classList.add('active');
            const progressBar = document.getElementById('aptProgress');
            const statusDiv = document.getElementById('aptStatus');
            
            const aptSteps = [
                'Setting up package sources...',
                'Downloading package lists...',
                'Validating package signatures...',
                'Configuring APT...',
                'Updating package cache...'
            ];

            let step = 0;
            function updateAptProgress() {
                if (step < aptSteps.length) {
                    statusDiv.textContent = aptSteps[step];
                    progressBar.style.width = ((step + 1) / aptSteps.length * 100) + '%';
                    step++;
                    setTimeout(updateAptProgress, Math.random() * 2000 + 1000);
                } else {
                    setTimeout(() => nextStep('packageScreen'), 1000);
                }
            }
            updateAptProgress();
        }

        function startInstallation() {
            document.getElementById('installScreen').classList.add('active');
            const progressBar = document.getElementById('installProgress');
            const statusDiv = document.getElementById('installStatus');
            
            const installSteps = [
                'Preparing installation...',
                'Creating partitions...',
                'Formatting filesystems...',
                'Installing base system...',
                'Installing kernel...',
                'Configuring system...',
                'Installing essential packages...',
                'Setting up users...',
                'Finalizing base installation...'
            ];

            let step = 0;
            function updateProgress() {
                if (step < installSteps.length) {
                    statusDiv.textContent = installSteps[step];
                    progressBar.style.width = ((step + 1) / installSteps.length * 100) + '%';
                    step++;
                    setTimeout(updateProgress, Math.random() * 2500 + 1500);
                } else {
                    setTimeout(() => nextStep('aptScreen'), 1000);
                }
            }
            updateProgress();
        }

        function rebootSystem() {
            document.querySelectorAll('.installer-screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show reboot messages
            const bootScreen = document.getElementById('bootScreen');
            bootScreen.style.display = 'block';
            bootScreen.innerHTML = '';
            
            const rebootMessages = [
                'System is rebooting...',
                '',
                'GRUB loading...',
                '',
                'GNU GRUB version 2.06',
                '',
                '   Debian GNU/Linux',
                '   Advanced options for Debian GNU/Linux',
                '',
                'Use the â†‘ and â†“ keys to select which entry is highlighted.',
                'Press enter to boot the selected OS, `e` to edit the commands',
                'before booting or `c` for a command-line.',
                '',
                'The highlighted entry will be executed automatically in 5s.',
                '',
                'Loading Linux 5.10.0-21-amd64 ...',
                'Loading initial ramdisk ...',
                '',
                '[    0.000000] Linux version 5.10.0-21-amd64',
                '[    0.123456] Memory: 2048MB available',
                '[    1.234567] Starting system...',
                '[    2.345678] Mounting filesystems...',
                '[    3.456789] Starting network...',
                '[    4.567890] Starting SSH daemon...',
                '[    5.678901] System ready.',
                ''
            ];

            let i = 0;
            function showRebootMessage() {
                if (i < rebootMessages.length) {
                    bootScreen.innerHTML += rebootMessages[i] + '\n';
                    bootScreen.scrollTop = bootScreen.scrollHeight;
                    i++;
                    setTimeout(showRebootMessage, Math.random() * 300 + 100);
                } else {
                    setTimeout(showLoginScreen, 1000);
                }
            }
            showRebootMessage();
        }

        function showLoginScreen() {
            console.log('showLoginScreen called');
            
            // Hide all other screens
            document.querySelectorAll('.installer-screen, .terminal').forEach(screen => {
                screen.style.display = 'none';
                screen.classList.remove('active');
            });
            
            const bootScreen = document.getElementById('bootScreen');
            bootScreen.style.display = 'none';
            bootScreen.innerHTML = '';
            
            const loginScreen = document.getElementById('loginScreen');
            const loginContent = document.getElementById('loginContent');
            
            console.log('Login screen element:', loginScreen);
            console.log('Login content element:', loginContent);
            
            // Force show login screen with multiple methods
            loginScreen.style.display = 'block !important';
            loginScreen.style.visibility = 'visible';
            loginScreen.classList.add('active');
            
            const hostname = installationData.hostname || 'debian';
            
            // Show available login credentials
            let credentialsInfo = '\nAvailable login credentials:\n';
            credentialsInfo += `root / ${users.root.password}\n`;
            if (installationData.username && users[installationData.username]) {
                credentialsInfo += `${installationData.username} / ${users[installationData.username].password}\n`;
            }
            
            const loginText = `Debian GNU/Linux 11 ${hostname} tty1
${credentialsInfo}
${hostname} login: <span class="cursor">_</span>`;
            
            loginContent.innerHTML = loginText;
            console.log('Login content set:', loginText);
            
            // Auto-activate mobile input for login screen
            if (isMobile) {
                setTimeout(() => {
                    console.log('Auto-activating mobile input for login');
                    activateMobileInput();
                }, 1000);
            }
            
            // Force all styles
            loginScreen.style.zIndex = '9999';
            loginScreen.style.position = 'fixed';
            loginScreen.style.top = '0';
            loginScreen.style.left = '0';
            loginScreen.style.width = '100vw';
            loginScreen.style.height = '100vh';
            loginScreen.style.background = '#000';
            loginScreen.style.color = '#fff';
            loginScreen.style.fontFamily = 'Courier New, monospace';
            loginScreen.style.padding = '20px';
            loginScreen.style.overflow = 'auto';
            
            console.log('Login screen should now be visible');
            
            // Handle login input
            let loginStep = 'username';
            let inputBuffer = '';
            
            // Register login handler for mobile support
            if (!document._loginHandlers) {
                document._loginHandlers = [];
            }
            
            function loginHandler(e) {
                if (!loginScreen.classList.contains('active')) return;
                
                if (e.key === 'Enter') {
                    if (loginStep === 'username') {
                        if (users[inputBuffer]) {
                            loginContent.innerHTML += inputBuffer + '\nPassword: ';
                            loginStep = 'password';
                            inputBuffer = '';
                        } else {
                            loginContent.innerHTML += inputBuffer + '\nLogin incorrect\n\n' + hostname + ' login: ';
                            inputBuffer = '';
                        }
                    } else if (loginStep === 'password') {
                        // Check if user exists and password matches
                        const lines = loginContent.innerHTML.split('\n');
                        let username = 'root';
                        
                        // Find the username from the login prompt
                        for (let i = lines.length - 1; i >= 0; i--) {
                            if (lines[i].includes(' login: ') && !lines[i].includes('Password:')) {
                                const match = lines[i].match(/login: (.+)$/);
                                if (match) {
                                    username = match[1].trim();
                                    break;
                                }
                            }
                        }
                        
                        if (users[username] && inputBuffer === users[username].password) {
                            currentUser = username;
                            currentDirectory = users[username].home;
                            
                            loginContent.innerHTML += '\nLast login: ' + new Date().toLocaleString() + ' on tty1\n';
                            loginContent.innerHTML += 'Linux ' + hostname + ' 5.10.0-21-amd64 #1 SMP Debian 5.10.162-1 (2023-01-21) x86_64\n\n';
                            loginContent.innerHTML += 'The programs included with the Debian GNU/Linux system are free software;\n';
                            loginContent.innerHTML += 'the exact distribution terms for each program are described in the\n';
                            loginContent.innerHTML += 'individual files in /usr/share/doc/*/copyright.\n\n';
                            loginContent.innerHTML += 'Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\n';
                            loginContent.innerHTML += 'permitted by applicable law.\n';
                            const currentPrompt = getCurrentPrompt();
                            loginContent.innerHTML += currentPrompt + '<span class="cursor">_</span>';
                            loginStep = 'shell';
                            inputBuffer = '';
                        } else {
                            loginContent.innerHTML += '\nLogin incorrect\n\n' + hostname + ' login: ';
                            loginStep = 'username';
                            inputBuffer = '';
                        }
                    } else if (loginStep === 'shell') {
                        executeCommand(inputBuffer);
                        inputBuffer = '';
                    }
                } else if (e.key === 'Backspace') {
                    if (inputBuffer.length > 0) {
                        inputBuffer = inputBuffer.slice(0, -1);
                        updateLoginDisplay();
                    }
                } else if (e.key.length === 1) {
                    inputBuffer += e.key;
                    updateLoginDisplay();
                }
                
                e.preventDefault();
            }
            
            // Register the handler
            document._loginHandlers.push(loginHandler);
            document.addEventListener('keydown', loginHandler);
            
            function updateLoginDisplay() {
                const lines = loginContent.innerHTML.split('\n');
                const lastLine = lines[lines.length - 1];
                
                if (loginStep === 'username') {
                    lines[lines.length - 1] = hostname + ' login: ' + inputBuffer + '<span class="cursor">_</span>';
                } else if (loginStep === 'password') {
                    lines[lines.length - 1] = 'Password: ' + '*'.repeat(inputBuffer.length) + '<span class="cursor">_</span>';
                } else if (loginStep === 'shell') {
                    const currentPrompt = getCurrentPrompt();
                    lines[lines.length - 1] = currentPrompt + inputBuffer + '<span class="cursor">_</span>';
                }
                
                loginContent.innerHTML = lines.join('\n');
            }
            
            // Virtual filesystem and user management - Initialize immediately
            let currentDirectory = '/root';
            let currentUser = 'root';
            let users = {};
            let installedPackages = ['base-files', 'bash', 'coreutils', 'openssh-server']; // Default installed packages
            let services = {}; // Will be initialized in initializeSystem
            let filesystem = {};
            
            // Initialize system immediately
            initializeSystem();
            
            function initializeSystem() {
                // Initialize users
                users = {
                    'root': {
                        password: installationData.rootPassword || 'root123', // Default password if not set
                        home: '/root',
                        shell: '/bin/bash',
                        uid: 0,
                        gid: 0,
                        groups: ['root']
                    }
                };
                
                // Add regular user if created during installation
                if (installationData.username && installationData.userPassword) {
                    users[installationData.username] = {
                        password: installationData.userPassword,
                        home: '/home/' + installationData.username,
                        shell: '/bin/bash',
                        uid: 1000,
                        gid: 1000,
                        groups: [installationData.username, 'users', 'sudo']
                    };
                }
                
                // Initialize services based on installed packages
                services = {
                    'ssh': { status: 'active', enabled: true, installed: installedPackages.includes('openssh-server') },
                    'sshd': { status: 'active', enabled: true, installed: installedPackages.includes('openssh-server') },
                    'openssh-server': { status: 'active', enabled: true, installed: installedPackages.includes('openssh-server') },
                    'samba': { status: 'inactive', enabled: false, installed: installedPackages.includes('samba') },
                    'smbd': { status: 'inactive', enabled: false, installed: installedPackages.includes('samba') },
                    'nmbd': { status: 'inactive', enabled: false, installed: installedPackages.includes('samba') },
                    'isc-dhcp-server': { status: 'inactive', enabled: false, installed: installedPackages.includes('isc-dhcp-server') },
                    'dhcpd': { status: 'inactive', enabled: false, installed: installedPackages.includes('isc-dhcp-server') },
                    'bind9': { status: 'inactive', enabled: false, installed: installedPackages.includes('bind9') },
                    'named': { status: 'inactive', enabled: false, installed: installedPackages.includes('bind9') },
                    'vsftpd': { status: 'inactive', enabled: false, installed: installedPackages.includes('vsftpd') },
                    'apache2': { status: 'inactive', enabled: false, installed: installedPackages.includes('apache2') },
                    'nginx': { status: 'inactive', enabled: false, installed: installedPackages.includes('nginx') },
                    'mysql': { status: 'inactive', enabled: false, installed: installedPackages.includes('mysql-server') },
                    'mariadb': { status: 'inactive', enabled: false, installed: installedPackages.includes('mariadb-server') }
                };
                
                initializeFilesystem();
            }
            
            function initializeFilesystem() {
                filesystem = {
                '/': {
                    type: 'directory',
                    contents: {
                        'root': {
                            type: 'directory',
                            contents: {
                                'Desktop': { type: 'directory', contents: {} },
                                'Documents': { type: 'directory', contents: {} },
                                'Downloads': { type: 'directory', contents: {} },
                                'Music': { type: 'directory', contents: {} },
                                'Pictures': { type: 'directory', contents: {} },
                                'Videos': { type: 'directory', contents: {} }
                            }
                        },
                        'home': { type: 'directory', contents: {} },
                        'etc': { 
                            type: 'directory', 
                            contents: {
                                'passwd': { 
                                    type: 'file', 
                                    content: generatePasswdFile(),
                                    size: generatePasswdFile().length
                                },
                                'shadow': {
                                    type: 'file',
                                    content: 'root:$6$encrypted$hash:18000:0:99999:7:::\n',
                                    size: 45
                                },
                                'hostname': {
                                    type: 'file',
                                    content: installationData.hostname || 'debian',
                                    size: (installationData.hostname || 'debian').length
                                }
                            }
                        },
                        'var': { type: 'directory', contents: {} },
                        'usr': { type: 'directory', contents: {} },
                        'tmp': { type: 'directory', contents: {} }
                    }
                }
            };

                // Initialize home directories for users created during installation
                if (installationData.username) {
                    filesystem['/'].contents.home.contents[installationData.username] = {
                        type: 'directory',
                        contents: {
                            'Desktop': { type: 'directory', contents: {} },
                            'Documents': { type: 'directory', contents: {} },
                            'Downloads': { type: 'directory', contents: {} },
                            'Music': { type: 'directory', contents: {} },
                            'Pictures': { type: 'directory', contents: {} },
                            'Videos': { type: 'directory', contents: {} }
                        }
                    };
                }
            }

            function generatePasswdFile() {
                let passwdContent = 'root:x:0:0:root:/root:/bin/bash\n';
                if (installationData.username) {
                    passwdContent += `${installationData.username}:x:1000:1000:${installationData.fullName || installationData.username}:/home/${installationData.username}:/bin/bash\n`;
                }
                return passwdContent;
            }

            function getDirectoryContents(path) {
                const parts = path.split('/').filter(p => p);
                let current = filesystem['/'];
                
                for (const part of parts) {
                    if (current.contents && current.contents[part]) {
                        current = current.contents[part];
                    } else {
                        return null;
                    }
                }
                return current;
            }

            function createDirectory(path, name) {
                const dir = getDirectoryContents(path);
                if (dir && dir.type === 'directory') {
                    if (!dir.contents[name]) {
                        dir.contents[name] = { type: 'directory', contents: {} };
                        return true;
                    }
                }
                return false;
            }

            function removeDirectory(path, name) {
                const dir = getDirectoryContents(path);
                if (dir && dir.type === 'directory' && dir.contents[name]) {
                    delete dir.contents[name];
                    return true;
                }
                return false;
            }

            function renameItem(path, oldName, newName) {
                const dir = getDirectoryContents(path);
                if (dir && dir.type === 'directory' && dir.contents[oldName] && !dir.contents[newName]) {
                    dir.contents[newName] = dir.contents[oldName];
                    delete dir.contents[oldName];
                    return true;
                }
                return false;
            }

            function executeCommand(cmd) {
                const hostname = installationData.hostname || 'debian';
                let output = '';
                const args = cmd.trim().split(' ');
                const command = args[0];
                
                // Remove the cursor and add newline for command execution
                const lines = loginContent.innerHTML.split('\n');
                const lastLine = lines[lines.length - 1];
                const cleanLastLine = lastLine.replace('<span class="cursor">_</span>', '');
                lines[lines.length - 1] = cleanLastLine;
                loginContent.innerHTML = lines.join('\n') + '\n';
                
                switch(command) {
                    case 'ls':
                        const lsDir = getDirectoryContents(currentDirectory);
                        if (lsDir && lsDir.contents) {
                            if (args.includes('-la') || args.includes('-l')) {
                                output = 'total ' + Object.keys(lsDir.contents).length * 4 + '\n';
                                output += 'drwx------  2 root root 4096 Jan 21 10:30 .\n';
                                output += 'drwxr-xr-x  3 root root 4096 Jan 21 10:25 ..\n';
                                for (const [name, item] of Object.entries(lsDir.contents)) {
                                    const type = item.type === 'directory' ? 'd' : '-';
                                    output += `${type}rwx------  2 root root 4096 Jan 21 10:30 ${name}\n`;
                                }
                            } else {
                                const items = Object.keys(lsDir.contents);
                                output = items.length > 0 ? items.join('  ') : '';
                            }
                        } else {
                            output = 'ls: cannot access directory';
                        }
                        break;
                        
                    case 'pwd':
                        output = currentDirectory;
                        break;
                        
                    case 'cd':
                        if (args.length === 1) {
                            currentDirectory = '/root';
                        } else {
                            let targetPath = args[1];
                            if (targetPath === '..') {
                                const parts = currentDirectory.split('/').filter(p => p);
                                if (parts.length > 1) {
                                    parts.pop();
                                    currentDirectory = '/' + parts.join('/');
                                } else {
                                    currentDirectory = '/';
                                }
                            } else if (targetPath === '.') {
                                // Stay in current directory
                            } else if (targetPath.startsWith('/')) {
                                // Absolute path
                                const targetDir = getDirectoryContents(targetPath);
                                if (targetDir && targetDir.type === 'directory') {
                                    currentDirectory = targetPath;
                                } else {
                                    output = `cd: ${targetPath}: No such file or directory`;
                                }
                            } else {
                                // Relative path
                                const newPath = currentDirectory === '/' ? '/' + targetPath : currentDirectory + '/' + targetPath;
                                const targetDir = getDirectoryContents(newPath);
                                if (targetDir && targetDir.type === 'directory') {
                                    currentDirectory = newPath;
                                } else {
                                    output = `cd: ${targetPath}: No such file or directory`;
                                }
                            }
                        }
                        break;
                        
                    case 'mkdir':
                        if (args.length < 2) {
                            output = 'mkdir: missing operand\nTry "mkdir --help" for more information.';
                        } else {
                            const dirName = args[1];
                            if (createDirectory(currentDirectory, dirName)) {
                                // Success, no output
                            } else {
                                output = `mkdir: cannot create directory '${dirName}': File exists`;
                            }
                        }
                        break;
                        
                    case 'rmdir':
                        if (args.length < 2) {
                            output = 'rmdir: missing operand\nTry "rmdir --help" for more information.';
                        } else {
                            const dirName = args[1];
                            const dir = getDirectoryContents(currentDirectory);
                            if (dir && dir.contents[dirName] && dir.contents[dirName].type === 'directory') {
                                if (Object.keys(dir.contents[dirName].contents).length === 0) {
                                    removeDirectory(currentDirectory, dirName);
                                } else {
                                    output = `rmdir: failed to remove '${dirName}': Directory not empty`;
                                }
                            } else {
                                output = `rmdir: failed to remove '${dirName}': No such file or directory`;
                            }
                        }
                        break;
                        
                    case 'rm':
                        if (args.length < 2) {
                            output = 'rm: missing operand\nTry "rm --help" for more information.';
                        } else if (args.includes('-rf') || args.includes('-r')) {
                            const dirName = args[args.length - 1];
                            if (removeDirectory(currentDirectory, dirName)) {
                                // Success, no output
                            } else {
                                output = `rm: cannot remove '${dirName}': No such file or directory`;
                            }
                        } else {
                            output = 'rm: cannot remove directory (use -r for recursive removal)';
                        }
                        break;
                        
                    case 'mv':
                        if (args.length < 3) {
                            output = 'mv: missing operand\nTry "mv --help" for more information.';
                        } else {
                            const oldName = args[1];
                            const newName = args[2];
                            if (renameItem(currentDirectory, oldName, newName)) {
                                // Success, no output
                            } else {
                                output = `mv: cannot move '${oldName}' to '${newName}': No such file or directory`;
                            }
                        }
                        break;
                        
                    case 'whoami':
                        output = 'root';
                        break;
                        
                    case 'id':
                        output = 'uid=0(root) gid=0(root) groups=0(root)';
                        break;
                        
                    case 'uname':
                        if (args.includes('-a')) {
                            output = 'Linux ' + hostname + ' 5.10.0-21-amd64 #1 SMP Debian 5.10.162-1 (2023-01-21) x86_64 GNU/Linux';
                        } else if (args.includes('-r')) {
                            output = '5.10.0-21-amd64';
                        } else {
                            output = 'Linux';
                        }
                        break;
                        
                    case 'date':
                        output = new Date().toString();
                        break;
                        
                    case 'uptime':
                        output = ' 10:35:42 up 5 min,  1 user,  load average: 0.08, 0.12, 0.05';
                        break;
                        
                    case 'df':
                        if (args.includes('-h')) {
                            output = 'Filesystem      Size  Used Avail Use% Mounted on\n/dev/sda2        18G  1.2G   16G   7% /\n/dev/sda1       976M   77M  833M   9% /boot\ntmpfs           1.0G     0  1.0G   0% /dev/shm\ntmpfs           5.0M     0  5.0M   0% /run/lock';
                        } else {
                            output = 'Filesystem     1K-blocks    Used Available Use% Mounted on\n/dev/sda2       18874368 1258496  16651392   7% /\n/dev/sda1         999320   78848    851840   9% /boot';
                        }
                        break;
                        
                    case 'free':
                        if (args.includes('-h')) {
                            output = '               total        used        free      shared  buff/cache   available\nMem:           2.0Gi       156Mi       1.7Gi       8.0Mi       112Mi       1.7Gi\nSwap:          975Mi          0B       975Mi';
                        } else {
                            output = '              total        used        free      shared  buff/cache   available\nMem:        2097152      159744     1781760        8192      114688     1781760\nSwap:        998396           0      998396';
                        }
                        break;
                        
                    case 'ps':
                        if (args.includes('aux')) {
                            output = 'USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot           1  0.0  0.1  22548  2048 ?        Ss   10:30   0:01 /sbin/init\nroot         123  0.0  0.0  12345  1024 ?        S    10:31   0:00 [kthreadd]\nroot         456  0.0  0.1  15678  2048 tty1     Ss+  10:32   0:00 /sbin/getty\nroot         789  0.0  0.2  18901  4096 pts/0    Ss   10:35   0:00 -bash';
                        } else {
                            output = '    PID TTY          TIME CMD\n    789 pts/0    00:00:00 bash';
                        }
                        break;
                        
                    case 'cat':
                        if (args.length < 2) {
                            output = 'cat: missing operand\nTry "cat --help" for more information.';
                        } else {
                            const fileName = args[1];
                            
                            // Handle special system files
                            if (fileName === '/etc/debian_version') {
                                output = '11.6';
                            } else if (fileName === '/etc/passwd') {
                                const etcDir = getDirectoryContents('/etc');
                                if (etcDir && etcDir.contents && etcDir.contents.passwd) {
                                    output = etcDir.contents.passwd.content;
                                } else {
                                    output = 'root:x:0:0:root:/root:/bin/bash\n';
                                }
                            } else if (fileName === '/etc/hostname') {
                                output = installationData.hostname || 'debian';
                            } else {
                                // Check if file exists in current directory
                                const dir = getDirectoryContents(currentDirectory);
                                if (dir && dir.contents && dir.contents[fileName] && dir.contents[fileName].type === 'file') {
                                    output = dir.contents[fileName].content || '';
                                } else {
                                    // Try absolute path
                                    const absoluteDir = getDirectoryContents(fileName.substring(0, fileName.lastIndexOf('/')) || '/');
                                    const baseName = fileName.substring(fileName.lastIndexOf('/') + 1);
                                    if (absoluteDir && absoluteDir.contents && absoluteDir.contents[baseName] && absoluteDir.contents[baseName].type === 'file') {
                                        output = absoluteDir.contents[baseName].content || '';
                                    } else {
                                        output = `cat: ${fileName}: No such file or directory`;
                                    }
                                }
                            }
                        }
                        break;
                        
                    case 'lscpu':
                        output = 'Architecture:                    x86_64\nCPU op-mode(s):                  32-bit, 64-bit\nByte Order:                      Little Endian\nCPU(s):                          4\nModel name:                      Intel(R) Core(TM) i5-8250U CPU @ 1.60GHz\nCPU MHz:                         1600.000\nCache L1d:                       128 KiB\nCache L1i:                       128 KiB\nCache L2:                        1 MiB\nCache L3:                        6 MiB';
                        break;
                        
                    case 'tree':
                        function buildTree(dir, prefix = '', isLast = true) {
                            let result = '';
                            const items = Object.entries(dir.contents || {});
                            items.forEach(([name, item], index) => {
                                const isLastItem = index === items.length - 1;
                                const connector = isLastItem ? 'â””â”€â”€ ' : 'â”œâ”€â”€ ';
                                result += prefix + connector + name + '\n';
                                if (item.type === 'directory' && Object.keys(item.contents).length > 0) {
                                    const newPrefix = prefix + (isLastItem ? '    ' : 'â”‚   ');
                                    result += buildTree(item, newPrefix, isLastItem);
                                }
                            });
                            return result;
                        }
                        const currentDir = getDirectoryContents(currentDirectory);
                        if (currentDir) {
                            output = '.\n' + buildTree(currentDir);
                        }
                        break;
                        
                    case 'touch':
                        if (args.length < 2) {
                            output = 'touch: missing operand\nTry "touch --help" for more information.';
                        } else {
                            const fileName = args[1];
                            const dir = getDirectoryContents(currentDirectory);
                            if (dir && dir.type === 'directory') {
                                dir.contents[fileName] = { type: 'file', content: '', size: 0 };
                                // Success, no output
                            } else {
                                output = `touch: cannot create '${fileName}': Permission denied`;
                            }
                        }
                        break;
                        
                    case 'nano':
                        if (args.length < 2) {
                            output = 'nano: missing operand\nTry "nano --help" for more information.';
                        } else {
                            const fileName = args[1];
                            openNanoEditor(fileName);
                            return; // Don't show prompt until nano exits
                        }
                        break;
                        
                    case 'chmod':
                        if (args.length < 3) {
                            output = 'chmod: missing operand\nUsage: chmod MODE FILE';
                        } else {
                            const mode = args[1];
                            const fileName = args[2];
                            const dir = getDirectoryContents(currentDirectory);
                            if (dir && dir.contents && dir.contents[fileName]) {
                                dir.contents[fileName].permissions = mode;
                                // Success, no output
                            } else {
                                output = `chmod: cannot access '${fileName}': No such file or directory`;
                            }
                        }
                        break;
                        
                    case 'chown':
                        if (args.length < 3) {
                            output = 'chown: missing operand\nUsage: chown USER FILE';
                        } else {
                            const user = args[1];
                            const fileName = args[2];
                            const dir = getDirectoryContents(currentDirectory);
                            if (dir && dir.contents && dir.contents[fileName]) {
                                dir.contents[fileName].owner = user;
                                // Success, no output
                            } else {
                                output = `chown: cannot access '${fileName}': No such file or directory`;
                            }
                        }
                        break;
                        
                    case 'clear':
                        const currentPrompt = getCurrentPrompt();
                        loginContent.innerHTML = currentPrompt + '<span class="cursor">_</span>';
                        loginContent.scrollTop = loginContent.scrollHeight;
                        return;
                        
                    case 'adduser':
                        if (args.length < 2) {
                            output = 'adduser: missing operand\nUsage: adduser USERNAME';
                        } else {
                            const username = args[1];
                            if (addUser(username)) {
                                output = `Adding user \`${username}' ...\nAdding new group \`${username}' (${users[username].uid}) ...\nAdding new user \`${username}' (${users[username].uid}) with group \`${username}' ...\nCreating home directory \`/home/${username}' ...\nCopying files from \`/etc/skel' ...\nNew password: (password set to 'password123')\nRetype new password: (confirmed)\nChanging the user information for ${username}\nEnter the new value, or press ENTER for the default\n\tFull Name []: \n\tRoom Number []: \n\tWork Phone []: \n\tHome Phone []: \n\tOther []: \nIs the information correct? [Y/n] Y\nUser ${username} added successfully.\nDefault password: password123`;
                            } else {
                                output = `adduser: The user \`${username}' already exists.`;
                            }
                        }
                        break;
                        
                    case 'deluser':
                        if (args.length < 2) {
                            output = 'deluser: missing operand\nUsage: deluser USERNAME';
                        } else {
                            const username = args[1];
                            if (removeUser(username)) {
                                output = `Removing user \`${username}' ...\nWarning: group \`${username}' has no more members.\nDone.`;
                            } else if (username === 'root') {
                                output = 'deluser: Cannot remove root user';
                            } else {
                                output = `deluser: The user \`${username}' does not exist.`;
                            }
                        }
                        break;
                        
                    case 'usermod':
                        if (args.length < 2) {
                            output = 'usermod: missing operand\nUsage: usermod [options] USERNAME';
                        } else {
                            const username = args[args.length - 1];
                            output = `User ${username} modified successfully.`;
                        }
                        break;
                        
                    case 'passwd':
                        if (args.length === 1) {
                            const newPassword = 'newpassword' + Math.floor(Math.random() * 100);
                            if (changePassword(currentUser, newPassword)) {
                                output = `Changing password for ${currentUser}.\nNew password: (password input simulated)\nRetype new password: (password input simulated)\npasswd: password updated successfully\nNew password: ${newPassword}`;
                                // Update installation data if changing root password
                                if (currentUser === 'root') {
                                    installationData.rootPassword = newPassword;
                                }
                            } else {
                                output = 'passwd: password change failed';
                            }
                        } else {
                            const username = args[1];
                            if (users[username]) {
                                const newPassword = 'newpassword' + Math.floor(Math.random() * 100);
                                if (changePassword(username, newPassword)) {
                                    output = `Changing password for ${username}.\nNew password: (password input simulated)\nRetype new password: (password input simulated)\npasswd: password updated successfully\nNew password: ${newPassword}`;
                                } else {
                                    output = 'passwd: password change failed';
                                }
                            } else {
                                output = `passwd: user '${username}' does not exist`;
                            }
                        }
                        break;
                        
                    case 'su':
                        if (args.length < 2) {
                            // Switch to root if no username provided
                            if (currentUser !== 'root') {
                                currentUser = 'root';
                                currentDirectory = users['root'].home;
                                output = `Password: (password input simulated)\nSwitched to root`;
                            } else {
                                output = 'Already logged in as root';
                            }
                        } else {
                            const username = args[1];
                            if (users[username]) {
                                currentUser = username;
                                currentDirectory = users[username].home;
                                output = `Password: (password input simulated)\nSwitched to user ${username}`;
                            } else {
                                output = `su: user ${username} does not exist`;
                            }
                        }
                        break;
                        
                    case 'groups':
                        const username = args.length > 1 ? args[1] : 'root';
                        if (username === 'root') {
                            output = 'root : root';
                        } else {
                            output = `${username} : ${username} sudo`;
                        }
                        break;
                        
                    case 'exit':
                        loginContent.innerHTML += 'logout\n\n' + hostname + ' login: <span class="cursor">_</span>';
                        loginStep = 'username';
                        loginContent.scrollTop = loginContent.scrollHeight;
                        return;
                        
                    case 'help':
                        output = 'Available commands:\n\nFile/Directory Management:\n  ls, ls -la     - list directory contents\n  cd <dir>       - change directory\n  pwd            - print working directory\n  mkdir <name>   - create directory\n  rmdir <name>   - remove empty directory\n  rm -rf <name>  - remove directory recursively\n  mv <old> <new> - rename/move file or directory\n  tree           - display directory tree\n  touch <file>   - create empty file\n  nano <file>    - edit file with nano editor\n  chmod <perm> <file> - change file permissions\n  chown <user> <file> - change file ownership\n\nUser Management:\n  adduser <name> - add new user\n  deluser <name> - delete user\n  usermod <opts> <user> - modify user account\n  passwd [user]  - change password (current user or specified)\n  su <user>      - switch user\n  groups [user]  - show user groups\n\nSystem Administration:\n  passwd         - change root password\n  hostname <name> - change system hostname\n  systemctl status <service> - check service status\n  systemctl start <service>  - start service\n  systemctl stop <service>   - stop service\n  systemctl enable <service> - enable service at boot\n  systemctl disable <service> - disable service at boot\n  systemctl restart <service> - restart service\n\nPackage Management:\n  apt update     - update package lists\n  apt install <pkg> - install package\n  apt remove <pkg>  - remove package\n  apt search <pkg>  - search for package\n  dpkg -l        - list installed packages\n\nNetwork Services:\n  Install: samba, isc-dhcp-server, bind9, openssh-server, vsftpd\n  Configure: /etc/samba/smb.conf, /etc/dhcp/dhcpd.conf, /etc/bind/\n\nSystem Information:\n  whoami, id, uname -a, uname -r, date, uptime\n  df -h, free -h, ps aux, lscpu, cat /etc/debian_version\n  netstat -tulpn - show network connections\n  ss -tulpn      - show socket statistics\n\nOther:\n  clear          - clear terminal screen\n  exit           - logout from current session\n  help           - show this help message';
                        break;
                        
                    case '':
                        break;
                        
                    case 'hostname':
                        if (args.length === 1) {
                            output = installationData.hostname || 'debian';
                        } else {
                            const newHostname = args[1];
                            installationData.hostname = newHostname;
                            output = `Hostname changed to: ${newHostname}`;
                        }
                        break;
                        
                    case 'systemctl':
                        if (args.length < 2) {
                            output = 'systemctl: missing operand\nUsage: systemctl COMMAND [SERVICE]';
                        } else {
                            const action = args[1];
                            const service = args[2] || '';
                            
                            // Get service descriptions
                            const serviceDescriptions = {
                                'ssh': 'OpenBSD Secure Shell server',
                                'sshd': 'OpenBSD Secure Shell server',
                                'openssh-server': 'OpenBSD Secure Shell server',
                                'samba': 'Samba SMB/CIFS server',
                                'smbd': 'Samba SMB/CIFS file server',
                                'nmbd': 'Samba NetBIOS name server',
                                'isc-dhcp-server': 'ISC DHCP IPv4 server',
                                'dhcpd': 'ISC DHCP IPv4 server',
                                'bind9': 'BIND Domain Name Server',
                                'named': 'Berkeley Internet Name Domain (DNS)',
                                'vsftpd': 'vsftpd FTP server',
                                'apache2': 'The Apache HTTP Server',
                                'nginx': 'A high performance web server and a reverse proxy server',
                                'mysql': 'MySQL Community Server',
                                'mariadb': 'MariaDB 10.5.19 database server'
                            };
                            
                            switch(action) {
                                case 'status':
                                    if (!service) {
                                        output = 'systemctl status: missing service name';
                                        break;
                                    }
                                    
                                    // Check if service exists and is installed
                                    if (!services[service] || !services[service].installed) {
                                        output = `Unit ${service}.service could not be found.`;
                                    } else {
                                        const svc = services[service];
                                        const description = serviceDescriptions[service] || `${service} service`;
                                        const timestamp = new Date().toLocaleString('en-US', {
                                            weekday: 'short',
                                            year: 'numeric',
                                            month: 'short',
                                            day: '2-digit',
                                            hour: '2-digit',
                                            minute: '2-digit',
                                            second: '2-digit'
                                        });
                                        
                                        const statusIcon = svc.status === 'active' ? 'â—' : 'â—‹';
                                        const statusColor = svc.status === 'active' ? 'active' : 'inactive';
                                        const runningState = svc.status === 'active' ? 'running' : 'dead';
                                        const mainPID = svc.status === 'active' ? Math.floor(Math.random() * 9000) + 1000 : 'N/A';
                                        const tasks = svc.status === 'active' ? Math.floor(Math.random() * 5) + 1 : 0;
                                        const memory = svc.status === 'active' ? (Math.floor(Math.random() * 50) + 10) + '.0M' : '0B';
                                        
                                        output = `${statusIcon} ${service}.service - ${description}
   Loaded: loaded (/lib/systemd/system/${service}.service; ${svc.enabled ? 'enabled' : 'disabled'}; vendor preset: enabled)
   Active: ${statusColor} (${runningState}) since ${timestamp}
     Docs: man:${service}(8)
 Main PID: ${mainPID} (${service})
    Tasks: ${tasks} (limit: 2359)
   Memory: ${memory}
   CGroup: /system.slice/${service}.service`;
                                        
                                        if (svc.status === 'active') {
                                            output += `\n           â””â”€${mainPID} /usr/sbin/${service}`;
                                        }
                                        
                                        // Add recent log entries simulation
                                        const logEntries = [
                                            `${timestamp.split(' ').slice(0, 3).join(' ')} ${installationData.hostname || 'debian'} systemd[1]: Starting ${description}...`,
                                            `${timestamp.split(' ').slice(0, 3).join(' ')} ${installationData.hostname || 'debian'} systemd[1]: Started ${description}.`
                                        ];
                                        
                                        if (svc.status === 'active') {
                                            logEntries.push(`${timestamp.split(' ').slice(0, 3).join(' ')} ${installationData.hostname || 'debian'} ${service}[${mainPID}]: Server listening on 0.0.0.0 port ${getServicePort(service)}.`);
                                        }
                                        
                                        output += '\n\n' + logEntries.join('\n');
                                    }
                                    break;
                                    
                                case 'start':
                                    if (!service) {
                                        output = 'systemctl start: missing service name';
                                        break;
                                    }
                                    
                                    if (!services[service] || !services[service].installed) {
                                        output = `Failed to start ${service}.service: Unit ${service}.service not found.`;
                                    } else if (services[service].status === 'active') {
                                        output = `Job for ${service}.service skipped because it is already active.`;
                                    } else {
                                        services[service].status = 'active';
                                        // No output for successful start (systemctl behavior)
                                    }
                                    break;
                                    
                                case 'stop':
                                    if (!service) {
                                        output = 'systemctl stop: missing service name';
                                        break;
                                    }
                                    
                                    if (!services[service] || !services[service].installed) {
                                        output = `Failed to stop ${service}.service: Unit ${service}.service not found.`;
                                    } else if (services[service].status === 'inactive') {
                                        output = `Job for ${service}.service skipped because it is not active.`;
                                    } else {
                                        services[service].status = 'inactive';
                                        // No output for successful stop (systemctl behavior)
                                    }
                                    break;
                                    
                                case 'restart':
                                    if (!service) {
                                        output = 'systemctl restart: missing service name';
                                        break;
                                    }
                                    
                                    if (!services[service] || !services[service].installed) {
                                        output = `Failed to restart ${service}.service: Unit ${service}.service not found.`;
                                    } else {
                                        services[service].status = 'active';
                                        // No output for successful restart (systemctl behavior)
                                    }
                                    break;
                                    
                                case 'enable':
                                    if (!service) {
                                        output = 'systemctl enable: missing service name';
                                        break;
                                    }
                                    
                                    if (!services[service] || !services[service].installed) {
                                        output = `Failed to enable unit: Unit file ${service}.service does not exist.`;
                                    } else if (services[service].enabled) {
                                        output = `Synchronizing state of ${service}.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable ${service}
The unit files have no installation config (WantedBy, RequiredBy, Also, Alias
settings in the [Install] section, and DefaultInstance for template units).
This means they are not meant to be enabled using systemctl.
Possible reasons for having this kind of units are:
1) A unit may be statically enabled by being symlinked from another unit's
   .wants/ or .requires/ directory.
2) A unit's purpose may be to act as a helper for some other unit which has
   a requirement dependency on it.
3) A unit may be started when needed via activation (socket, path, timer,
   D-Bus, udev, scripted systemctl call, ...).
4) In case of template units, the unit is meant to be enabled with some
   instance name specified.`;
                                    } else {
                                        services[service].enabled = true;
                                        output = `Created symlink /etc/systemd/system/multi-user.target.wants/${service}.service â†’ /lib/systemd/system/${service}.service.`;
                                    }
                                    break;
                                    
                                case 'disable':
                                    if (!service) {
                                        output = 'systemctl disable: missing service name';
                                        break;
                                    }
                                    
                                    if (!services[service] || !services[service].installed) {
                                        output = `Failed to disable unit: Unit file ${service}.service does not exist.`;
                                    } else if (!services[service].enabled) {
                                        output = `Synchronizing state of ${service}.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install disable ${service}`;
                                    } else {
                                        services[service].enabled = false;
                                        output = `Removed /etc/systemd/system/multi-user.target.wants/${service}.service.`;
                                    }
                                    break;
                                    
                                case 'reload':
                                    if (!service) {
                                        output = 'systemctl reload: missing service name';
                                        break;
                                    }
                                    
                                    if (!services[service] || !services[service].installed) {
                                        output = `Failed to reload ${service}.service: Unit ${service}.service not found.`;
                                    } else if (services[service].status === 'inactive') {
                                        output = `Failed to reload ${service}.service: Unit ${service}.service is not active, cannot reload.`;
                                    } else {
                                        // No output for successful reload (systemctl behavior)
                                    }
                                    break;
                                    
                                case 'is-active':
                                    if (!service) {
                                        output = 'systemctl is-active: missing service name';
                                        break;
                                    }
                                    
                                    if (!services[service] || !services[service].installed) {
                                        output = 'unknown';
                                    } else {
                                        output = services[service].status;
                                    }
                                    break;
                                    
                                case 'is-enabled':
                                    if (!service) {
                                        output = 'systemctl is-enabled: missing service name';
                                        break;
                                    }
                                    
                                    if (!services[service] || !services[service].installed) {
                                        output = 'Failed to get unit file state for ' + service + '.service: No such file or directory';
                                    } else {
                                        output = services[service].enabled ? 'enabled' : 'disabled';
                                    }
                                    break;
                                    
                                case 'list-units':
                                    output = 'UNIT                     LOAD   ACTIVE SUB     DESCRIPTION\n';
                                    for (const [serviceName, serviceData] of Object.entries(services)) {
                                        if (serviceData.installed) {
                                            const description = serviceDescriptions[serviceName] || `${serviceName} service`;
                                            const load = 'loaded';
                                            const active = serviceData.status;
                                            const sub = serviceData.status === 'active' ? 'running' : 'dead';
                                            output += `${serviceName.padEnd(24)} ${load.padEnd(6)} ${active.padEnd(6)} ${sub.padEnd(7)} ${description}\n`;
                                        }
                                    }
                                    output += '\nLOAD   = Reflects whether the unit definition was properly loaded.\nACTIVE = The high-level unit activation state, i.e. generalization of SUB.\nSUB    = The low-level unit activation state, values depend on unit type.';
                                    break;
                                    
                                default:
                                    output = `systemctl: invalid command '${action}'\nValid commands: status, start, stop, restart, reload, enable, disable, is-active, is-enabled, list-units`;
                            }
                        }
                        
                        function getServicePort(service) {
                            const ports = {
                                'ssh': 22, 'sshd': 22, 'openssh-server': 22,
                                'apache2': 80, 'nginx': 80,
                                'mysql': 3306, 'mariadb': 3306,
                                'bind9': 53, 'named': 53,
                                'vsftpd': 21,
                                'samba': 445, 'smbd': 445, 'nmbd': 137,
                                'isc-dhcp-server': 67, 'dhcpd': 67
                            };
                            return ports[service] || 8080;
                        }
                        break;
                        
                    case 'apt':
                        if (args.length < 2) {
                            output = 'apt: missing operand\nUsage: apt COMMAND [PACKAGE]';
                        } else {
                            const action = args[1];
                            const package = args[2] || '';
                            
                            switch(action) {
                                case 'update':
                                    output = 'Hit:1 http://deb.debian.org/debian bullseye InRelease\nGet:2 http://security.debian.org/debian-security bullseye-security InRelease [48.4 kB]\nGet:3 http://deb.debian.org/debian bullseye-updates InRelease [44.1 kB]\nFetched 92.5 kB in 2s (46.2 kB/s)\nReading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\n3 packages can be upgraded. Run \'apt list --upgradable\' to see them.';
                                    break;
                                case 'install':
                                    if (!package) {
                                        output = 'apt install: missing package name';
                                    } else {
                                        const availablePackages = ['samba', 'isc-dhcp-server', 'bind9', 'openssh-server', 'vsftpd', 'apache2', 'nginx', 'mysql-server', 'mariadb-server'];
                                        if (availablePackages.includes(package)) {
                                            if (!installedPackages.includes(package)) {
                                                installedPackages.push(package);
                                                // Update service installation status
                                                if (services[package]) {
                                                    services[package].installed = true;
                                                }
                                                // Update related services
                                                if (package === 'samba') {
                                                    if (services['smbd']) services['smbd'].installed = true;
                                                    if (services['nmbd']) services['nmbd'].installed = true;
                                                } else if (package === 'isc-dhcp-server') {
                                                    if (services['dhcpd']) services['dhcpd'].installed = true;
                                                } else if (package === 'bind9') {
                                                    if (services['named']) services['named'].installed = true;
                                                } else if (package === 'mysql-server') {
                                                    if (services['mysql']) services['mysql'].installed = true;
                                                } else if (package === 'mariadb-server') {
                                                    if (services['mariadb']) services['mariadb'].installed = true;
                                                }
                                                output = `Reading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\nThe following NEW packages will be installed:\n  ${package}\n0 upgraded, 1 newly installed, 0 to remove and 3 not upgraded.\nNeed to get 2,345 kB of archives.\nAfter this operation, 8,192 kB of additional disk space will be used.\nGet:1 http://deb.debian.org/debian bullseye/main amd64 ${package} amd64 [2,345 kB]\nFetched 2,345 kB in 3s (781 kB/s)\nSelecting previously unselected package ${package}.\n(Reading database ... 123456 files and directories currently installed.)\nPreparing to unpack .../${package}_amd64.deb ...\nUnpacking ${package} ...\nSetting up ${package} ...\nProcessing triggers for systemd (247.3-7+deb11u4) ...\n${package} installed successfully.`;
                                            } else {
                                                output = `${package} is already the newest version.\n0 upgraded, 0 newly installed, 0 to remove and 3 not upgraded.`;
                                            }
                                        } else {
                                            output = `E: Unable to locate package ${package}`;
                                        }
                                    }
                                    break;
                                case 'remove':
                                    if (!package) {
                                        output = 'apt remove: missing package name';
                                    } else {
                                        if (installedPackages.includes(package)) {
                                            installedPackages = installedPackages.filter(p => p !== package);
                                            // Update service installation status
                                            if (services[package]) {
                                                services[package].installed = false;
                                                services[package].status = 'inactive';
                                                services[package].enabled = false;
                                            }
                                            // Update related services
                                            if (package === 'samba') {
                                                if (services['smbd']) {
                                                    services['smbd'].installed = false;
                                                    services['smbd'].status = 'inactive';
                                                    services['smbd'].enabled = false;
                                                }
                                                if (services['nmbd']) {
                                                    services['nmbd'].installed = false;
                                                    services['nmbd'].status = 'inactive';
                                                    services['nmbd'].enabled = false;
                                                }
                                            } else if (package === 'isc-dhcp-server') {
                                                if (services['dhcpd']) {
                                                    services['dhcpd'].installed = false;
                                                    services['dhcpd'].status = 'inactive';
                                                    services['dhcpd'].enabled = false;
                                                }
                                            } else if (package === 'bind9') {
                                                if (services['named']) {
                                                    services['named'].installed = false;
                                                    services['named'].status = 'inactive';
                                                    services['named'].enabled = false;
                                                }
                                            } else if (package === 'mysql-server') {
                                                if (services['mysql']) {
                                                    services['mysql'].installed = false;
                                                    services['mysql'].status = 'inactive';
                                                    services['mysql'].enabled = false;
                                                }
                                            } else if (package === 'mariadb-server') {
                                                if (services['mariadb']) {
                                                    services['mariadb'].installed = false;
                                                    services['mariadb'].status = 'inactive';
                                                    services['mariadb'].enabled = false;
                                                }
                                            }
                                            output = `Reading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\nThe following packages will be REMOVED:\n  ${package}\n0 upgraded, 0 newly installed, 1 to remove and 3 not upgraded.\nAfter this operation, 8,192 kB disk space will be freed.\nRemoving ${package} ...\nProcessing triggers for systemd (247.3-7+deb11u4) ...\n${package} removed successfully.`;
                                        } else {
                                            output = `Package '${package}' is not installed, so not removed`;
                                        }
                                    }
                                    break;
                                case 'search':
                                    if (!package) {
                                        output = 'apt search: missing search term';
                                    } else {
                                        output = `Sorting... Done\nFull Text Search... Done\n${package}/stable 1.2.3-4 amd64\n  ${package} - Sample package description\n\nsamba/stable 2:4.13.13+dfsg-1~deb11u5 amd64\n  SMB/CIFS file, print, and login server for Unix\n\nbind9/stable 1:9.16.27-1~deb11u2 amd64\n  Internet Domain Name Server`;
                                    }
                                    break;
                                default:
                                    output = `apt: invalid command '${action}'\nValid commands: update, install, remove, search`;
                            }
                        }
                        break;
                        
                    case 'dpkg':
                        if (args.includes('-l')) {
                            output = 'Desired=Unknown/Install/Remove/Purge/Hold\n| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend\n|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)\n||/ Name                    Version          Architecture Description\n+++-=======================-================-============-================================\nii  adduser                 3.118            all          add and remove users and groups\nii  apt                     2.2.4            amd64        commandline package manager\nii  base-files              11.1+deb11u7     amd64        Debian base system miscellaneous files\nii  bash                    5.1-2+deb11u1    amd64        GNU Bourne Again SHell\nii  coreutils               8.32-4+b1        amd64        GNU core utilities';
                            
                            // Add installed packages
                            installedPackages.forEach(pkg => {
                                const descriptions = {
                                    'openssh-server': 'secure shell (SSH) server',
                                    'samba': 'SMB/CIFS file, print, and login server',
                                    'isc-dhcp-server': 'ISC DHCP server for automatic IP address assignment',
                                    'bind9': 'Internet Domain Name Server',
                                    'vsftpd': 'lightweight, efficient FTP server',
                                    'apache2': 'Apache HTTP Server',
                                    'nginx': 'small, powerful, scalable web/proxy server',
                                    'mysql-server': 'MySQL database server',
                                    'mariadb-server': 'MariaDB database server'
                                };
                                const desc = descriptions[pkg] || `${pkg} package`;
                                output += `\nii  ${pkg.padEnd(23)} 1.0.0            amd64        ${desc}`;
                            });
                        } else {
                            output = 'dpkg: missing operand\nTry "dpkg --help" for more information.';
                        }
                        break;
                        
                    case 'netstat':
                        if (args.includes('-tulpn')) {
                            output = 'Active Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      789/sshd: /usr/sbin\ntcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1234/master\ntcp6       0      0 :::22                   :::*                    LISTEN      789/sshd: /usr/sbin\nudp        0      0 0.0.0.0:68              0.0.0.0:*                           567/dhclient';
                        } else {
                            output = 'netstat: missing operand\nTry "netstat --help" for more information.';
                        }
                        break;
                        
                    case 'ss':
                        if (args.includes('-tulpn')) {
                            output = 'Netid  State   Recv-Q  Send-Q   Local Address:Port    Peer Address:Port  Process\ntcp    LISTEN  0       128            0.0.0.0:22           0.0.0.0:*      users:(("sshd",pid=789,fd=3))\ntcp    LISTEN  0       100          127.0.0.1:25           0.0.0.0:*      users:(("master",pid=1234,fd=13))\ntcp    LISTEN  0       128               [::]:22              [::]:*      users:(("sshd",pid=789,fd=4))\nudp    UNCONN  0       0              0.0.0.0:68           0.0.0.0:*      users:(("dhclient",pid=567,fd=6))';
                        } else {
                            output = 'ss: missing operand\nTry "ss --help" for more information.';
                        }
                        break;
                        
                    default:
                        output = 'bash: ' + command + ': command not found\nType "help" for available commands.';
                }
                
                if (output) {
                    loginContent.innerHTML += output + '\n';
                }
                
                const currentPrompt = getCurrentPrompt();
                loginContent.innerHTML += currentPrompt + '<span class="cursor">_</span>';
                loginContent.scrollTop = loginContent.scrollHeight;
            }

            // Nano Editor Functions
            function openNanoEditor(fileName) {
                const nanoEditor = document.getElementById('nanoEditor');
                const nanoFilename = document.getElementById('nanoFilename');
                const nanoTextarea = document.getElementById('nanoTextarea');
                const nanoStatus = document.getElementById('nanoStatus');
                
                // Get file content if it exists
                const dir = getDirectoryContents(currentDirectory);
                let fileContent = '';
                let isNewFile = true;
                let originalContent = '';
                
                // Handle absolute paths
                let targetDir = dir;
                let targetFileName = fileName;
                
                if (fileName.includes('/')) {
                    const pathParts = fileName.split('/');
                    targetFileName = pathParts.pop();
                    const dirPath = pathParts.join('/') || '/';
                    targetDir = getDirectoryContents(dirPath);
                }
                
                if (targetDir && targetDir.contents && targetDir.contents[targetFileName] && targetDir.contents[targetFileName].type === 'file') {
                    fileContent = targetDir.contents[targetFileName].content || '';
                    originalContent = fileContent;
                    isNewFile = false;
                }
                
                nanoFilename.textContent = fileName + (isNewFile ? ' [New File]' : '');
                nanoTextarea.value = fileContent;
                nanoEditor.classList.add('active');
                nanoTextarea.focus();
                
                let isModified = false;
                let savePromptActive = false;
                
                // Handle nano keyboard shortcuts
                function handleNanoKeydown(e) {
                    if (savePromptActive) return; // Don't handle other shortcuts during save prompt
                    
                    if (e.ctrlKey) {
                        switch(e.key.toLowerCase()) {
                            case 'x': // Exit
                                e.preventDefault();
                                if (isModified) {
                                    showSavePrompt();
                                } else {
                                    exitNano();
                                }
                                break;
                            case 'o': // Write Out (Save)
                                e.preventDefault();
                                saveFile();
                                break;
                            case 'g': // Help
                                e.preventDefault();
                                showNanoHelp();
                                break;
                            case 'w': // Where Is (Search)
                                e.preventDefault();
                                showNanoStatus('Search: ');
                                handleSearch();
                                break;
                            case 'k': // Cut line
                                e.preventDefault();
                                cutCurrentLine();
                                break;
                            case 'u': // Paste
                                e.preventDefault();
                                pasteText();
                                break;
                            case 'c': // Show cursor position
                                e.preventDefault();
                                showCursorPosition();
                                break;
                        }
                    }
                }
                
                let cutBuffer = '';
                
                function cutCurrentLine() {
                    const textarea = nanoTextarea;
                    const start = textarea.selectionStart;
                    const value = textarea.value;
                    
                    // Find start and end of current line
                    let lineStart = value.lastIndexOf('\n', start - 1) + 1;
                    let lineEnd = value.indexOf('\n', start);
                    if (lineEnd === -1) lineEnd = value.length;
                    
                    // Cut the line
                    cutBuffer = value.substring(lineStart, lineEnd + (lineEnd < value.length ? 1 : 0));
                    const newValue = value.substring(0, lineStart) + value.substring(lineEnd + (lineEnd < value.length ? 1 : 0));
                    
                    textarea.value = newValue;
                    textarea.setSelectionRange(lineStart, lineStart);
                    handleTextChange();
                    
                    showNanoStatus(`[ Cut 1 line ]`);
                    setTimeout(() => hideNanoStatus(), 1500);
                }
                
                function pasteText() {
                    if (cutBuffer) {
                        const textarea = nanoTextarea;
                        const start = textarea.selectionStart;
                        const end = textarea.selectionEnd;
                        const value = textarea.value;
                        
                        const newValue = value.substring(0, start) + cutBuffer + value.substring(end);
                        textarea.value = newValue;
                        textarea.setSelectionRange(start + cutBuffer.length, start + cutBuffer.length);
                        handleTextChange();
                        
                        showNanoStatus(`[ Pasted 1 line ]`);
                        setTimeout(() => hideNanoStatus(), 1500);
                    } else {
                        showNanoStatus('[ Nothing to paste ]');
                        setTimeout(() => hideNanoStatus(), 1500);
                    }
                }
                
                function showCursorPosition() {
                    const textarea = nanoTextarea;
                    const value = textarea.value;
                    const pos = textarea.selectionStart;
                    
                    // Calculate line and column
                    const lines = value.substring(0, pos).split('\n');
                    const line = lines.length;
                    const col = lines[lines.length - 1].length + 1;
                    const totalLines = value.split('\n').length;
                    
                    showNanoStatus(`[ line ${line}/${totalLines} (${Math.round(line/totalLines*100)}%), col ${col} ]`);
                    setTimeout(() => hideNanoStatus(), 2000);
                }
                
                function handleSearch() {
                    let searchTerm = '';
                    
                    function handleSearchKeydown(e) {
                        if (e.key === 'Enter') {
                            if (searchTerm) {
                                performSearch(searchTerm);
                            }
                            hideNanoStatus();
                            document.removeEventListener('keydown', handleSearchKeydown);
                        } else if (e.key === 'Escape' || (e.ctrlKey && e.key.toLowerCase() === 'c')) {
                            hideNanoStatus();
                            document.removeEventListener('keydown', handleSearchKeydown);
                        } else if (e.key === 'Backspace') {
                            searchTerm = searchTerm.slice(0, -1);
                            showNanoStatus('Search: ' + searchTerm);
                        } else if (e.key.length === 1) {
                            searchTerm += e.key;
                            showNanoStatus('Search: ' + searchTerm);
                        }
                        e.preventDefault();
                    }
                    
                    document.addEventListener('keydown', handleSearchKeydown);
                }
                
                function performSearch(term) {
                    const textarea = nanoTextarea;
                    const value = textarea.value.toLowerCase();
                    const searchTerm = term.toLowerCase();
                    const currentPos = textarea.selectionStart;
                    
                    const index = value.indexOf(searchTerm, currentPos);
                    if (index !== -1) {
                        textarea.setSelectionRange(index, index + term.length);
                        textarea.focus();
                        showNanoStatus(`[ Found "${term}" ]`);
                    } else {
                        // Search from beginning
                        const indexFromStart = value.indexOf(searchTerm);
                        if (indexFromStart !== -1) {
                            textarea.setSelectionRange(indexFromStart, indexFromStart + term.length);
                            textarea.focus();
                            showNanoStatus(`[ Found "${term}" (wrapped) ]`);
                        } else {
                            showNanoStatus(`[ "${term}" not found ]`);
                        }
                    }
                    setTimeout(() => hideNanoStatus(), 2000);
                }
                
                function showNanoHelp() {
                    const helpText = `GNU nano 5.4 - Help Text

Main nano shortcuts:
^G  Get Help        ^O  Write Out      ^W  Where Is       ^K  Cut Text       ^J  Justify
^X  Exit            ^R  Read File      ^\\ Replace        ^U  Paste Text     ^T  To Spell
^Y  Prev Page       ^V  Next Page      ^_  Go To Line     ^C  Cur Pos        ^A  Beginning
^E  End             ^P  Prev Line      ^N  Next Line      ^F  Forward        ^B  Back

^G or F1 for this help text
^X to exit nano

Press any key to return to the editor...`;
                    
                    const originalContent = nanoTextarea.value;
                    nanoTextarea.value = helpText;
                    nanoTextarea.readOnly = true;
                    
                    function exitHelp(e) {
                        nanoTextarea.value = originalContent;
                        nanoTextarea.readOnly = false;
                        nanoTextarea.focus();
                        document.removeEventListener('keydown', exitHelp);
                        e.preventDefault();
                    }
                    
                    document.addEventListener('keydown', exitHelp);
                }
                
                function handleTextChange() {
                    const currentContent = nanoTextarea.value;
                    isModified = (currentContent !== originalContent);
                    
                    if (isModified && !nanoFilename.textContent.includes('[Modified]')) {
                        nanoFilename.textContent = fileName + (isNewFile ? ' [New File]' : '') + ' [Modified]';
                    } else if (!isModified) {
                        nanoFilename.textContent = fileName + (isNewFile ? ' [New File]' : '');
                    }
                }
                
                function saveFile() {
                    const content = nanoTextarea.value;
                    let targetDir = getDirectoryContents(currentDirectory);
                    let targetFileName = fileName;
                    
                    // Handle absolute paths
                    if (fileName.includes('/')) {
                        const pathParts = fileName.split('/');
                        targetFileName = pathParts.pop();
                        const dirPath = pathParts.join('/') || '/';
                        targetDir = getDirectoryContents(dirPath);
                    }
                    
                    if (targetDir && targetDir.type === 'directory') {
                        targetDir.contents[targetFileName] = {
                            type: 'file',
                            content: content,
                            size: content.length,
                            owner: currentUser,
                            permissions: '644',
                            modified: new Date().toISOString()
                        };
                        
                        originalContent = content;
                        isModified = false;
                        isNewFile = false;
                        nanoFilename.textContent = fileName;
                        
                        const lineCount = content.split('\n').length;
                        showNanoStatus(`[ Wrote ${lineCount} lines ]`);
                        setTimeout(() => hideNanoStatus(), 2000);
                    } else {
                        showNanoStatus('Error: Cannot save file - directory not found');
                        setTimeout(() => hideNanoStatus(), 2000);
                    }
                }
                
                function showSavePrompt() {
                    savePromptActive = true;
                    showNanoStatus('Save modified buffer? (Y/N/^C)');
                    
                    function handleSaveKeydown(e) {
                        if (e.key.toLowerCase() === 'y') {
                            saveFile();
                            setTimeout(() => exitNano(), 500);
                        } else if (e.key.toLowerCase() === 'n') {
                            exitNano();
                        } else if (e.ctrlKey && e.key.toLowerCase() === 'c') {
                            savePromptActive = false;
                            hideNanoStatus();
                            document.removeEventListener('keydown', handleSaveKeydown);
                        }
                        e.preventDefault();
                    }
                    
                    document.addEventListener('keydown', handleSaveKeydown);
                }
                
                function exitNano() {
                    nanoEditor.classList.remove('active');
                    document.removeEventListener('keydown', handleNanoKeydown);
                    nanoTextarea.removeEventListener('input', handleTextChange);
                    savePromptActive = false;
                    
                    // Clear any remaining event listeners
                    document.removeEventListener('keydown', arguments.callee);
                    
                    // Return to terminal
                    const currentPrompt = getCurrentPrompt();
                    loginContent.innerHTML += currentPrompt + '<span class="cursor">_</span>';
                    loginContent.scrollTop = loginContent.scrollHeight;
                }
                
                function showNanoStatus(message) {
                    nanoStatus.textContent = message;
                    nanoStatus.style.display = 'block';
                }
                
                function hideNanoStatus() {
                    nanoStatus.style.display = 'none';
                }
                
                // Add event listeners
                document.addEventListener('keydown', handleNanoKeydown);
                nanoTextarea.addEventListener('input', handleTextChange);
                
                // Enhanced mobile support for nano
                if (isMobile) {
                    console.log('Setting up mobile support for nano editor');
                    
                    // Auto-activate mobile input when nano opens
                    setTimeout(() => {
                        console.log('Auto-activating mobile input for nano');
                        if (!mobileInputActive) {
                            activateMobileInput();
                        }
                    }, 200);
                    
                    // Handle touch events on nano textarea
                    nanoTextarea.addEventListener('touchstart', function(e) {
                        console.log('Touch on nano textarea');
                        if (!mobileInputActive) {
                            activateMobileInput();
                        }
                        
                        // Set cursor position based on touch
                        const touch = e.touches[0];
                        const rect = nanoTextarea.getBoundingClientRect();
                        const x = touch.clientX - rect.left;
                        const y = touch.clientY - rect.top;
                        
                        // Calculate approximate cursor position
                        const style = window.getComputedStyle(nanoTextarea);
                        const fontSize = parseInt(style.fontSize);
                        const charWidth = fontSize * 0.6; // Approximate monospace character width
                        const lineHeight = parseInt(style.lineHeight) || fontSize * 1.2;
                        
                        const col = Math.max(0, Math.floor(x / charWidth));
                        const row = Math.max(0, Math.floor(y / lineHeight));
                        
                        const lines = nanoTextarea.value.split('\n');
                        let pos = 0;
                        
                        // Calculate position
                        for (let i = 0; i < row && i < lines.length; i++) {
                            pos += lines[i].length + 1; // +1 for newline
                        }
                        if (row < lines.length) {
                            pos += Math.min(col, lines[row].length);
                        } else if (lines.length > 0) {
                            // If touch is beyond last line, go to end of last line
                            pos = nanoTextarea.value.length;
                        }
                        
                        nanoTextarea.setSelectionRange(pos, pos);
                        console.log('Set cursor position to:', pos);
                        
                        // Ensure mobile input stays active
                        setTimeout(() => {
                            const mobileInput = document.getElementById('mobileInput');
                            mobileInput.focus();
                        }, 50);
                        
                        e.preventDefault();
                    });
                    
                    // Handle touch end to maintain focus
                    nanoTextarea.addEventListener('touchend', function(e) {
                        setTimeout(() => {
                            if (mobileInputActive) {
                                const mobileInput = document.getElementById('mobileInput');
                                mobileInput.focus();
                            }
                        }, 100);
                        e.preventDefault();
                    });
                }
            }

            // Enhanced User Management Functions
            function addUser(username, password = 'password123') {
                if (users[username]) {
                    return false; // User already exists
                }
                
                const uid = Object.keys(users).length + 1000;
                const homeDir = '/home/' + username;
                
                users[username] = {
                    password: password,
                    home: homeDir,
                    shell: '/bin/bash',
                    uid: uid,
                    gid: uid,
                    groups: [username, 'users']
                };
                
                // Create home directory
                const homeParent = getDirectoryContents('/home');
                if (homeParent && homeParent.type === 'directory') {
                    homeParent.contents[username] = {
                        type: 'directory',
                        contents: {
                            'Desktop': { type: 'directory', contents: {} },
                            'Documents': { type: 'directory', contents: {} },
                            'Downloads': { type: 'directory', contents: {} }
                        }
                    };
                }
                
                // Update /etc/passwd
                const etcDir = getDirectoryContents('/etc');
                if (etcDir && etcDir.contents && etcDir.contents.passwd) {
                    etcDir.contents.passwd.content += `${username}:x:${uid}:${uid}:${username}:${homeDir}:/bin/bash\n`;
                    etcDir.contents.passwd.size = etcDir.contents.passwd.content.length;
                }
                
                return true;
            }
            
            function removeUser(username) {
                if (!users[username] || username === 'root') {
                    return false;
                }
                
                // Remove user from users object
                delete users[username];
                
                // Remove home directory
                const homeParent = getDirectoryContents('/home');
                if (homeParent && homeParent.contents && homeParent.contents[username]) {
                    delete homeParent.contents[username];
                }
                
                // Update /etc/passwd
                const etcDir = getDirectoryContents('/etc');
                if (etcDir && etcDir.contents && etcDir.contents.passwd) {
                    const lines = etcDir.contents.passwd.content.split('\n');
                    const filteredLines = lines.filter(line => !line.startsWith(username + ':'));
                    etcDir.contents.passwd.content = filteredLines.join('\n');
                    etcDir.contents.passwd.size = etcDir.contents.passwd.content.length;
                }
                
                return true;
            }
            
            function changePassword(username, newPassword) {
                if (users[username]) {
                    users[username].password = newPassword;
                    return true;
                }
                return false;
            }

            function getCurrentPrompt() {
                const hostname = installationData.hostname || 'debian';
                let displayPath = currentDirectory;
                
                // Convert home directory to ~ for display
                const userHome = users[currentUser].home;
                if (currentDirectory === userHome) {
                    displayPath = '~';
                } else if (currentDirectory.startsWith(userHome + '/')) {
                    displayPath = '~' + currentDirectory.substring(userHome.length);
                }
                
                const promptChar = currentUser === 'root' ? '#' : '$';
                return `${currentUser}@${hostname}:${displayPath}${promptChar} `;
            }
        }

        // Enhanced Mobile Support Functions
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                      ('ontouchstart' in window) || 
                      (navigator.maxTouchPoints > 0) || 
                      window.innerWidth <= 768;
        let mobileInputActive = false;
        let mobileInputBuffer = '';
        let touchStartTime = 0;

        function initializeMobileSupport() {
            const mobileKeyboardBtn = document.getElementById('mobileKeyboard');
            const mobileInput = document.getElementById('mobileInput');
            const mobileStatus = document.getElementById('mobileStatus');
            
            console.log('Mobile detection:', isMobile);
            
            if (isMobile) {
                mobileKeyboardBtn.style.display = 'block';
                mobileStatus.style.display = 'block';
                
                // Show mobile status briefly
                setTimeout(() => {
                    mobileStatus.style.display = 'none';
                }, 3000);
                
                // Mobile keyboard button click
                mobileKeyboardBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (!mobileInputActive) {
                        activateMobileInput();
                    } else {
                        deactivateMobileInput();
                    }
                });
                
                // Handle mobile input changes
                mobileInput.addEventListener('input', function(e) {
                    if (mobileInputActive) {
                        const newValue = e.target.value;
                        
                        // Handle text input
                        if (newValue.length > mobileInputBuffer.length) {
                            // Text was added
                            const addedText = newValue.substring(mobileInputBuffer.length);
                            for (let char of addedText) {
                                processMobileInput(char);
                            }
                        } else if (newValue.length < mobileInputBuffer.length) {
                            // Text was deleted (backspace)
                            const deletedCount = mobileInputBuffer.length - newValue.length;
                            for (let i = 0; i < deletedCount; i++) {
                                processMobileInput('Backspace');
                            }
                        }
                        
                        mobileInputBuffer = newValue;
                    }
                });
                
                // Handle mobile input special keys
                mobileInput.addEventListener('keydown', function(e) {
                    if (mobileInputActive) {
                        console.log('Mobile keydown:', e.key);
                        
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            processMobileInput('Enter');
                            // Clear input after Enter
                            setTimeout(() => {
                                mobileInput.value = '';
                                mobileInputBuffer = '';
                            }, 50);
                        } else if (e.key === 'Backspace') {
                            // Let the input event handle backspace
                            return;
                        }
                    }
                });
                
                // Handle composition events for international keyboards
                mobileInput.addEventListener('compositionend', function(e) {
                    if (mobileInputActive && e.data) {
                        // Process composed text
                        for (let char of e.data) {
                            processMobileInput(char);
                        }
                        mobileInput.value = '';
                        mobileInputBuffer = '';
                    }
                });
                
                // Auto-focus mobile input when login screen is active
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.target.classList.contains('login-screen') && 
                            mutation.target.classList.contains('active')) {
                            setTimeout(() => {
                                if (isMobile && !mobileInputActive) {
                                    activateMobileInput();
                                }
                            }, 500);
                        }
                    });
                });
                
                observer.observe(document.getElementById('loginScreen'), {
                    attributes: true,
                    attributeFilter: ['class']
                });
                
                // Enhanced touch support for terminal interaction
                document.addEventListener('touchstart', function(e) {
                    touchStartTime = Date.now();
                    
                    if (document.getElementById('loginScreen').classList.contains('active')) {
                        if (!mobileInputActive) {
                            // Auto-activate on first touch
                            setTimeout(() => activateMobileInput(), 100);
                        }
                    }
                });
                
                document.addEventListener('touchend', function(e) {
                    const touchDuration = Date.now() - touchStartTime;
                    
                    // If it's a quick tap on the terminal area
                    if (touchDuration < 300 && document.getElementById('loginScreen').classList.contains('active')) {
                        if (!mobileInputActive) {
                            activateMobileInput();
                        } else {
                            // Refocus the input to ensure keyboard stays open
                            const mobileInput = document.getElementById('mobileInput');
                            mobileInput.focus();
                        }
                    }
                });
                
                // Prevent zoom on double tap
                document.addEventListener('touchend', function(e) {
                    e.preventDefault();
                }, { passive: false });
            }
        }
        
        function activateMobileInput() {
            const mobileInput = document.getElementById('mobileInput');
            const mobileKeyboardBtn = document.getElementById('mobileKeyboard');
            
            console.log('Activating mobile input...');
            
            mobileInputActive = true;
            mobileKeyboardBtn.classList.add('active');
            mobileKeyboardBtn.textContent = 'âŒ¨ï¸ Active';
            
            // Clear any existing content first
            mobileInput.value = '';
            mobileInputBuffer = '';
            
            // Multiple attempts to focus and trigger keyboard
            setTimeout(() => {
                mobileInput.focus();
                mobileInput.click();
                
                // Additional trigger for stubborn keyboards
                setTimeout(() => {
                    mobileInput.focus();
                    // Simulate a touch event to ensure keyboard appears
                    const touchEvent = new TouchEvent('touchstart', {
                        bubbles: true,
                        cancelable: true,
                        touches: [new Touch({
                            identifier: 0,
                            target: mobileInput,
                            clientX: 0,
                            clientY: 0
                        })]
                    });
                    mobileInput.dispatchEvent(touchEvent);
                }, 100);
            }, 50);
            
            console.log('Mobile input activated');
        }
        
        function deactivateMobileInput() {
            const mobileInput = document.getElementById('mobileInput');
            const mobileKeyboardBtn = document.getElementById('mobileKeyboard');
            
            mobileInputActive = false;
            mobileKeyboardBtn.classList.remove('active');
            mobileKeyboardBtn.textContent = 'ðŸ“± Keyboard';
            
            mobileInput.blur();
        }
        
        function processMobileInput(input) {
            console.log('Processing mobile input:', input);
            
            // Create a synthetic keyboard event
            const event = {
                key: input === '\n' || input === 'Enter' ? 'Enter' : input === 'Backspace' ? 'Backspace' : input,
                ctrlKey: false,
                altKey: false,
                shiftKey: false,
                preventDefault: () => {},
                stopPropagation: () => {}
            };
            
            // Route to appropriate handler based on current screen
            if (document.getElementById('loginScreen').classList.contains('active')) {
                console.log('Routing to login screen');
                // Find the current login handler
                const handlers = document._loginHandlers || [];
                if (handlers.length > 0) {
                    handlers[handlers.length - 1](event);
                } else {
                    console.log('No login handlers found');
                }
            } else if (document.getElementById('nanoEditor').classList.contains('active')) {
                console.log('Routing to nano editor');
                // Handle nano editor input
                const nanoTextarea = document.getElementById('nanoTextarea');
                if (input === 'Enter' || input === '\n') {
                    const pos = nanoTextarea.selectionStart;
                    nanoTextarea.value = nanoTextarea.value.substring(0, pos) + '\n' + nanoTextarea.value.substring(pos);
                    nanoTextarea.setSelectionRange(pos + 1, pos + 1);
                } else if (input === 'Backspace') {
                    const pos = nanoTextarea.selectionStart;
                    if (pos > 0) {
                        nanoTextarea.value = nanoTextarea.value.substring(0, pos - 1) + nanoTextarea.value.substring(pos);
                        nanoTextarea.setSelectionRange(pos - 1, pos - 1);
                    }
                } else if (input.length === 1) {
                    const pos = nanoTextarea.selectionStart;
                    nanoTextarea.value = nanoTextarea.value.substring(0, pos) + input + nanoTextarea.value.substring(pos);
                    nanoTextarea.setSelectionRange(pos + 1, pos + 1);
                }
                
                // Trigger input event for nano
                nanoTextarea.dispatchEvent(new Event('input'));
            } else {
                console.log('No active screen found for input');
            }
        }

        // Initialize mobile support
        initializeMobileSupport();

        // Start the simulation
        startBoot();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96f513b631b28333',t:'MTc1NTIyMzAwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
